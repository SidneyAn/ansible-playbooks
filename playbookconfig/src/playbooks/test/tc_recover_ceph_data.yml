---
#
# Copyright (c) 2019 Wind River Systems, Inc.
#
# SPDX-License-Identifier: Apache-2.0
#
# Role of this playbook is to allow easy testing of ceph recovery process.
# To run it make sure that the normal platform restore playbook was
# executed with wipe_ceph_osds=false. Then run this playbook from sysadmin
# user with same params as the platform restore. E.g.: ' ansible-playbook
# /usr/share/ansible/stx-ansible/playbooks/bootstrap/tc_recover_ceph_data.yml
# -e "wipe_ceph_osds=false ansible_become_pass=<password> admin_password=<password>
# backup_filename=<backup.tgz>"'

- hosts: localhost
  gather_facts: no

  vars_files:
    - host_vars/default.yml

  pre_tasks:
    - name: Fail if backup_filename is not defined or set
      fail:
        msg: "Mandatory configuration parameter backup_filename is not defined or set."
      when: backup_filename is not defined or backup_filename is none

    - name: Set staging and target backup dirs
      set_fact:
        staging_dir: /scratch
        target_backup_dir: /scratch

    # Get system_type
    - name: Retrieve system type
      shell: source /etc/platform/platform.conf; echo $system_type
      register: system_type_result

    - name: Fail if system type is not defined
      fail:
        msg: "system_type is missing in /etc/platform/platform.conf"
      when: system_type_result.stdout_lines|length == 0

    - name: Set system type config path fact
      set_fact:
        system_type: "{{ system_type_result.stdout_lines[0] }}"

  roles:
    - { role: recover-ceph-data, become: yes }
